![image](https://github.com/eastperson/TIL/assets/66561524/6610139f-6220-4334-94a3-fc97528f9170)
Redis Sentinel deployment (extra monitoring/dashed lines from other sentinel nodes are left out for clarity).

Sentinel은 분산형 시스템입니다. 모든 분산 시스템과 마찬가지로 Sentinel에는 몇가지 장점과 단점이 있습니다. Sentinel은 Sentinel 프로세스 클러스터가 함께 작동하여 상태를 조정해 Redis에 고가용성을 제공하는 방식으로 설계되었다. 결국 장애로부터 사용자를 보호하는 시스템이 자체적인 단일 장애 지점을 갖는 것은 원치 않을 것입니다.

Sentinel은 여러가지 역할을 담당합니다. 첫째, 현재 주 인스턴스와 보조 인스턴스가 정상적으로 작동하고 응답하는지 확인합니다. 이는 센티널이 메인 및 보조 노드가손실되는 상황에 대해 경고하고 조치를 취할 수 있기 때문에 필요합니다. 둘째, 다른 시스템의 Zookeeper와 Consul 처럼 서비스 검색 역할을 수행합니다. 따라서 새 클라이언트가 Redis에 무언가를 쓰려고 시도할 때 Sentinel은 현재 메인 인스턴스가 무엇인지 클라이언트에게 알려줍니다.

따라서 Sentinel은 가용성을 지속적으로 모니터링하고 해당 정보를 고객에게 전송하여 장애조치시 고객이 대응할 수 있도록 합니다.

**Sentinel의 역할**

1. 모니터링Monitoring): 메인 및 보조 인스턴스가 예상대로 작동하는지 확인합니다.
2. 알림(Notification): 시스템 관리자에게 Redis 인스턴스 발생에 대해 알립니다.
3. 장애 조치 관리(Failover management): 메인 인스턴스를 사용할 수 없고 충분한 수의 노드가 동의하는 경우 Sentinel 노드가 장애 조치 프로세스를 시작할 수 있다.
4. 구성 관리(Configuration management): Sentinel 노드는 현재 기본 Redis 인스턴스의 검색 지점 역할도 합니다.

이 방식으로 Reids Sentinel을 사용하면 장애를 감지할 수 있습니다. 이 감지에는 현재 메인 인스턴스를 더 이상 사용할 수 없다고 동의하는 여러 센티널 프로세스가 포함됩니다. 이 동의 프로세스를 쿼럼(Quorum)이라고 합니다. 이를 통해 하나의 머신이 오작동을 일으켜 메인 Redis 노드에 도달할 수 없는 경우에 대비하여 견고성을 높이고 보호할 수 있습니다.

<aside>
💡 **Quorum**
쿼럼은 장애 조치와 같은 작업을 수행하기 위해 분산 시스템이 확보해야 하는 최소 투표  수입니다. 이 숫자는 구성할 수 있지만 해당 분산 시스템의 노드 수를 반영해야 합니다. 대부분의 분산 시스템의 크기는 3개 또는 5개이며 쿼럼은 각각 2개와 3개입니다. 시스템에서 과반수를 만들어야기 때문에 홀수 노드 수가 선호됩니다.

</aside>

이 설정에는 단점이 없는 것은 아니므로 Redis Sentinel을 사용할 때 몇가지 권장 사항과 모범 사례를 살펴보겠습니다.

여러가지 방법으로 Redis Sentinel을 배포할 수 있습니다. 일반적인 지침으로 가능한 경우 각 애플리케이션 옆에 센티널 노드를 실행하여 센티널 노드와 실제로 Redis를 사용하는 클라이언트 간의 네트워크 도달 가능성 차이를 고려할 필요가 없도록 하는 것을 권장합니다.

Redis 인스턴스와 함께 또는 독립 노드에서 Sentinel을 실행할 수도 있지만 그렇게 하면 여러 가지 방식으로 상황이 복잡해집니다. 최소한 쿼럼이 2개 이상인 노드 3개를 실행하는 것이 좋습니다. 당므은 클러스터의 서버 수와 관련 쿼럼 및 지속 가능한 허용되는 장애를 분석한 차트입니다.

| Number of Servers | Quorum | Number Of Tolerated Failures |
| --- | --- | --- |
| 1 | 1 | 0 |
| 2 | 2 | 0 |
| 3 | 2 | 1 |
| 4 | 3 | 1 |
| 5 | 3 | 2 |
| 6 | 4 | 2 |
| 7 | 4 | 3 |

서버 수 및 쿼럼 수와 허용되는 실패 횟수 표입니다. 시스템마다 다르지만 일반적인 개념은동일 합니다.

이러한 설정에서 무엇이 잘못될 수 있는지 잠시 생각해 봅시다. 이 시스템을 충분히 오래 실행하면 이러한 문제가 모두 발생할 수 있습니다.

센티널 노드가 쿼럼을 채우지 못하면 어떻게 되나요?

네트워크 분할이 발생하여 기존 메인 인스턴스가 소수 그룹에 속하게 되면 어떻게 되나요? 해당 쓰기는 어떻게 되나요? (스포일러: 시스템이 완전히 복구되면 손실됩니다.)

감시 노드와 클라이언트 노드(애플리케이션 노드)의 네트워크 토폴로지가 잘못 정렬되면 어떻게 되나요?😬

특히 디스크에 대한 지속성(아래 참조)이 비동기식이기 때문에 내구성을 보장할 수 없습니다. 또한 클라이언트가 새로운 프라이머리를 발견했을 때, 인지하지 못한 프라이머리로 인해 얼마나 많은 쓰기가 손실되었는지에 대한 성가신 문제도 있습니다. Redis는 새 연결이 설정될 때 새 프라이머리를 쿼리할 것을 권장합니다. 시스템 구성에 따라 이는 상당한 데이터 손실을 의미할 수 있습니다.
