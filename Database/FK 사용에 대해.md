# FK란?

- 우리가 알고있는 FK(Foreign Key)는 외부 식별자키로 테이블 간의 관계를 의미한다.
- 두 테이블 간의 종속이 필요한 관계이면 그 접점이 되는 컬럼을 FK로 지정하여 서로 참조할 수 있도록 관계를 맺어준다.
- 테이블 간 잘못된 매핑을 방지해준다.
- 그런데 현업에서는 FK를 사용하지 않으려는 경우가 꽤나 많다.

# FK Constration

- 지금 말하는 FK는 논리적인 의미의 FK가 아니라 FK constraint를 뜻한다.
- DB는 FK 선언을 안해도 join이 가능하고 index를 걸면 거의 동일한 성능으로 사용할 수 있다.

# FK는 왜필요하고 왜 피할까?

## FK 제약이 없으면?
- FK가 걸린 부모 row를 삭제해버릴 수 있어 자식 row들이 고아가 될 수 있다.
- 대상이 없는 FK를 걸어 정합성 문제가 생길 수 있다.

ORM을 사용하거나 단순한 CRUD는 그런 문제가 많이 발생하지 않지만 가끔 구멍이 생기는 경우를 FK 제약조건이 막아준다.


## FK 제약을 안쓰려는 이유는?
- bulk insrt를 할 때 테이블 단위로 하는데, 의존성 순서대로 할 수 없다
- FK가 여러 테이블간 순환을 형성할 때 insert가 실패하는 경우가 빈번하게 생긴다.
- 데이터를 삭제할 때 cascade를 챙기지 못하면 고아 row가 발생하기도 한다.
- cascade 설정에 의해 원하지 않는 데이터가 삭제할 수 있다.
- 스키마를 변경할 때 문제가 생길 수 있다.


## not null과 관련된 FK 문제
- not null인 FK 필드 때문에 많은 종류의 작업이 실패한다.
- fk 필드를 null로 하면 대게 해결이 되는데 FK가 nullable 인 것에 대해서도 말이 많다.


## ORM
- ORM은 FK의 장단점에 많은 영향을 끼친다.
- 데이터 정합성을 코드 레벨에서 방지할 수 있어 FK의 필요성이 줄어든다.
- 반대로 FK로 인한 불편도 많이 피해갈 수 있다.
- 따라서 FK를 쓰던 안쓰던 ORM을 사용하면 큰차이가 없어지게 되는 것이다.


## 샤딩
- 샤딩에도 FK 제약이 방해가 될 수 있다.
- 하지만 샤딩 전략에 따라 FK를 보존하면서 할 수 있는 경우도 많다.
- FK 제약이 방해가 되는 샤딩은 join도 DB레벨에서 할 수 없다. 따라서 코드레벨에서 좀 더 고통받는다.
- FK를 보존하는 방식의 샤딩을 선호한다.

# Conclusion

- 대형 DB에서는 FK 제약인 경우 복구가 어려워서 지양하는 경우도 있다고 한다.
- Test Data를 마련할 때 FK 제약은 매우 불편하다.
- 아직은 뚜렷한 결정이 안선다. 논란이 많고 취향도 들어가 있으므로 최대한 고민하고 테이블을 설계하자. 단, 정확한 테이블 설계와 ORM이 FK에 대한 고민을 덜어주므로 유연하게 구성하는 것으로 생각을 해도 좋을 듯하다.


https://twitter.com/pakyoungrok/status/1575519636535508992?s=20&t=y2978G4hXRDVvDavvL7y8g
